<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Writing a script in Python - nesman.dev</title><meta name="description" content="By trade I am not a software developer, but I find it interesting enough to sink hours of my life&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://nesman.dev/writing-a-script-in-python.html"><link rel="alternate" type="application/atom+xml" href="https://nesman.dev/feed.xml"><link rel="alternate" type="application/json" href="https://nesman.dev/feed.json"><meta property="og:title" content="Writing a script in Python"><meta property="og:image" content="https://nesman.dev/media/posts/7/featured_maps_page-2.PNG"><meta property="og:image:width" content="1209"><meta property="og:image:height" content="639"><meta property="og:site_name" content="nesman.dev"><meta property="og:description" content="By trade I am not a software developer, but I find it interesting enough to sink hours of my life&hellip;"><meta property="og:url" content="https://nesman.dev/writing-a-script-in-python.html"><meta property="og:type" content="article"><link rel="stylesheet" href="https://nesman.dev/assets/css/fontawesome-all.min.css?v=bbcde81f26378440dac4c3d195714389"><link rel="stylesheet" href="https://nesman.dev/assets/css/style.css?v=43f5994a789add140e56168b7d72445d"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://nesman.dev/writing-a-script-in-python.html"},"headline":"Writing a script in Python","datePublished":"2023-01-22T18:09","dateModified":"2023-01-22T20:30","image":{"@type":"ImageObject","url":"https://nesman.dev/media/posts/7/featured_maps_page-2.PNG","height":639,"width":1209},"description":"By trade I am not a software developer, but I find it interesting enough to sink hours of my life&hellip;","author":{"@type":"Person","name":"Neil Stottler","url":"https://nesman.dev/authors/neil-stottler/"},"publisher":{"@type":"Organization","name":"Neil Stottler"}}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.88/dist/themes/dark.css"><script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.88/dist/shoelace.js"></script></head><body class="is-preload"><div id="wrapper"><div id="main"><div class="inner"><header id="header"><a class="logo" href="https://nesman.dev/"><strong>nesman.dev</strong></a></header><article class="post"><header class="main post__header"><time datetime="2023-01-22T18:09" class="post__date">January 22, 2023</time><h1>Writing a script in Python</h1></header><figure class="image main"><img src="https://nesman.dev/media/posts/7/featured_maps_page-2.PNG" srcset="https://nesman.dev/media/posts/7/responsive/featured_maps_page-2-xs.PNG 300w, https://nesman.dev/media/posts/7/responsive/featured_maps_page-2-sm.PNG 480w, https://nesman.dev/media/posts/7/responsive/featured_maps_page-2-md.PNG 768w, https://nesman.dev/media/posts/7/responsive/featured_maps_page-2-lg.PNG 1024w, https://nesman.dev/media/posts/7/responsive/featured_maps_page-2-xl.PNG 1360w, https://nesman.dev/media/posts/7/responsive/featured_maps_page-2-xxl.PNG 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="lazy" height="639" width="1209" alt=""></figure><div class="post__inner post__entry"><p>By trade I am not a software developer, but I find it interesting enough to sink hours of my life into. As a hobbyist I have been picking up coding more and more just because of the usefulness of being able to make a custom script for a specific purpose when I need it.<br></p><hr class="separator separator--long-line"><h2 id="finding-a-purpose-and-filling-it">Finding a Purpose and Filling it</h2><p>Being a practical person who learns best by filling a need I was faced with a unique problem. For those who don't know, I am one of the Senior Staff members over at <a href="https://tf2maps.net">TF2Maps.net</a>&nbsp;and over the past year I have been using my skills learned in college to help keep the place running. I need to put that degree in Computer Networking to use after all. With that, I also use the need of keeping the place physically functioning to learn more.</p><p>With that comes the purpose I am trying to fill with this script. On TF2Maps.net we have this thing called maps, they are levels to the video game Team Fortress 2 and we are a community that focuses on the creation of these levels and everything needed to do so. Once a year we try to feature the best community made maps from that year or prior years if we missed something, let's call these featured maps. We also run two servers for playing Team Fortress 2 on. We want to be running these featured maps on these two servers, it is also important to know we have to configure the servers to run these maps using what is called a mapcycle.txt file, each file in that file represents a map that is in the "rotation". So what's the problem? There's a lot of maps, around 200 or so, and I would have to download each one of those maps, unzip or decompress it if it's like that, add it to the mapcycle.txt on each server, and then upload the map to each of the servers. That's a lot of work! Let's automate it.</p><hr class="separator separator--long-line"><h2 id="analyzing-options">Analyzing Options</h2><p>There's a couple of options for what we could do. We could use <a href="https://xenforo.com/docs/dev/rest-api/">Xenforo's REST API</a>&nbsp;to directly query the forums database for the file to download locally, I have the ability to make an API key since it is locked by default. We could use a Python library for scraping html pages, this would require no API tokens. I think for this it makes more sense to use a scraper since that doesn't require any database access.</p><p>The next thing to analyze is if I want this script to be something that runs on a server or not. I think for the time being it makes more sense to have this be a local script that I can run on my machine since I am developing it.</p><h2 id="looking-at-the-basics">Looking at The Basics</h2><p>Now I need to figure out my starting point. Our featured maps page, as seen below, provided me with some useful information believe it or not.&nbsp;</p><figure class="post__image post__image--center"><img loading="lazy" src="https://nesman.dev/media/posts/7/featured_maps_page.PNG" height="639" width="1209" alt="" sizes="(max-width: 48em) 100vw, 768px" srcset="https://nesman.dev/media/posts/7/responsive/featured_maps_page-xs.PNG 300w, https://nesman.dev/media/posts/7/responsive/featured_maps_page-sm.PNG 480w, https://nesman.dev/media/posts/7/responsive/featured_maps_page-md.PNG 768w"></figure><p>The featured maps page is a list if you think about it. Unordered but still a list. This list doesn't provide us with download files, but it provides us with means of getting those download files. Shown below is the download page for that specific map which we can use in the script.</p><figure class="post__image post__image--center"><img loading="lazy" src="https://nesman.dev/media/posts/7/featured_maps_code.PNG" height="231" width="796" alt="" sizes="(max-width: 48em) 100vw, 768px" srcset="https://nesman.dev/media/posts/7/responsive/featured_maps_code-xs.PNG 300w, https://nesman.dev/media/posts/7/responsive/featured_maps_code-sm.PNG 480w, https://nesman.dev/media/posts/7/responsive/featured_maps_code-md.PNG 768w"></figure><p>Parsing html files in Python isn't really native so I had to use a third-party library for this. BeautifulSoup4 is the most current version of a html scraper I've seen used before. With BS4 I can look for specific html elements and grab their associated values. Now that I have the list assembled in some order I can use each one of those links to point me to a download page for that map. On the download page it's a similar story where the only useful thing to me is a link hidden in a button. Grab it with the webscraper and download the file locally.</p><figure class="post__image post__image--center"><img loading="lazy" src="https://nesman.dev/media/posts/7/featured_maps_code2.PNG" height="133" width="986" alt="" sizes="(max-width: 48em) 100vw, 768px" srcset="https://nesman.dev/media/posts/7/responsive/featured_maps_code2-xs.PNG 300w, https://nesman.dev/media/posts/7/responsive/featured_maps_code2-sm.PNG 480w, https://nesman.dev/media/posts/7/responsive/featured_maps_code2-md.PNG 768w"></figure><p>I wasn't sure how to approach this so I looked online and found someone else's solution and modified it to my needs. I'll take the URL that I got earlier and the destination on my local system where to put the file for manipulation if needed.</p><pre class="line-numbers language-python"><code>async def download_file(link, destination):
    async with httpx.AsyncClient() as client:
        response = await client.get(link)

        with open(destination, "wb") as file:
            file.write(response.content)</code></pre><hr class="separator separator--long-line"><h2 id="file-manipulation">File Manipulation</h2><p>There are a couple of challenges with downloading the map files from about 150+ different people. Everyone uploads them differently! Some put their map files plus other stuff into a zip file, some are in a bz2 archive, and some are just the straight bsp's. I also need to sort out non-map featured content and mvm maps since those are put on their own server. This was something I had to sort through manually before, let's automate it. Because there are only three file types I am dealing with here this feature can be rather simple. I can just check if the file ends with one of the three specific filetypes and modify it if needed.</p><pre class="line-numbers language-python"><code>                maps = ['arena_', 'cp_', 'ctf_', 'koth_', 'pass_', 'pd_', 'pl_', 'plr_', 'sd_']

                #filter for mvm maps
                if downloaded_filename.startswith(tuple(maps)):
                    if downloaded_filename.endswith(".bsp"):
                        #to things

                    #bz2 check
                    if downloaded_filename.endswith(".bz2"):
                        #decompress and do things

                    #zip check
                    if downloaded_filename.endswith(".zip"):
                        #unzip and do things</code></pre><p>Now I can start messing with the files specifically. The zip file was the trickiest one to write as there were a bunch of edge cases I had to deal with. Different map authors have different standards, some put just their map into the zip file and nothing else while others put their map and other assets plus a readme.txt file. I had to filter through all this stuff and look for just the bsp. When I was getting the filename I decided to split it by slashes and look for the bsp that way and only extract that and discard the rest.</p><pre class="line-numbers language-python"><code>async def unzip_file(filepath, downloaded_filename):
    global bsp_file_name
    
    with ZipFile(filepath) as originalzip:
        zipcontents = ZipFile.infolist(originalzip)
        for file in zipcontents:
            #check for bsp in folders
            if file.filename.endswith('.bsp'):

                #this is only for mappers who put their map in a folder in a zip
                if '/' in file.filename:
                    desired_file = file.filename.split('/')

                    #get it
                    with open('maps/' + desired_file[1], 'wb') as fileoutput:
                        fileoutput.write(originalzip.read(str(file.filename)))
                        
                        #set this value for bz2 compression later
                        bsp_file_name = str(desired_file[1])
                else:
                    with open('maps/' + file.filename, 'wb') as fileoutput:
                        fileoutput.write(originalzip.read(str(file.filename)))

                        #set this value for bz2 compression later
                        bsp_file_name = str(file.filename)
    
    #remove zip file
    os.remove(os.getcwd() + '/maps/' + downloaded_filename)</code></pre><p>Similar to the zip files I had to extract the bsp from the bz2 file. Luckily bz2 is used on the fastdl server so the files that used this were standardized. Fastdl is what serves the player the map if they do now already have it downloaded, this is important for later.</p><pre class="line-numbers language-python"><code>async def bz2_decompress(filepath, downloaded_filename):
    global bsp_file_name

    with bz2.BZ2File(filepath) as f:
        data = f.read()
        newfilepath = filepath[:-4]
        open(newfilepath, 'wb').write(data)

        bsp_file_name = str(newfilepath).split('/')[-1]

    #remove bz2 after extracting
    os.remove(os.getcwd() + '/maps/' + downloaded_filename)</code></pre><p>Now that all the files are downloaded and the bsp's are exported I can add them to the mapcycle.txt file for use on the servers. This can be a very simple function as it's only writing to a text file and nothing more.</p><pre class="line-numbers language-python"><code>async def add_to_mapcycle(mapname):
    #print to mapcycle file
    with open("mapcycle.txt", "a") as f:
        splited = mapname.split(".")
        f.write(splited[0] + "\n")</code></pre><p>I also decided that I would compress the maps into a new folder in their bz2 format for the fastdl server to save me time later on. I could have copied the files that were already bz2 but decided it was easier to just decompress and then compress again.</p><pre class="line-numbers language-python"><code>async def compress_file(filepath):
    print(f'Compressing {filepath} for redirect.')
    output_filepath = os.getcwd() + '/compressed_maps/' + f"{filepath}.bz2"

    with open('maps/' + filepath, 'rb') as input:
        with bz2.BZ2File(output_filepath, 'wb') as output:
            shutil.copyfileobj(input, output)

    return output_filepath</code></pre><hr class="separator separator--long-line"><h2 id="conclusion">Conclusion</h2><p>Writing scripts is useful! This was a challenging script to write as I haven't messed with file decompression before. I hope to add the ability to auto upload them to the servers too but didn't want to do that for this release. BS4 is a very cool library for python and made making this script a lot easier. Thanks for making it this far, here's the <a href="https://github.com/neilstottler/featured-maps-grabber/blob/main/main.py">source code</a>.</p></div><footer class="post__inner post__footer"><p class="post__last-updated">This article was updated on January 22, 2023</p><div class="post__tag"><ul><li><strong>Tagged in:</strong></li><li><a href="https://nesman.dev/tags/coding/">Coding</a></li></ul></div></footer></article></div></div><div id="sidebar"><div class="inner"><nav id="menu"><header class="major"><h2>Menu</h2></header><ul><li><a href="https://nesman.dev/" title="Home" target="_self">Home</a></li><li><a href="https://nesman.dev/tags/level-design/" target="_self">Level Design</a></li><li><a href="https://nesman.dev/tags/it/" target="_self">IT Projects</a></li><li><a href="https://nesman.dev/tags/coding/" target="_self">Coding Projects</a></li><li><a href="https://nesman.dev/authors/neil-stottler/" target="_self">About</a></li><li class="has-submenu"><span aria-haspopup="true" class="opener">Contact</span><ul class="submenu level-2" aria-hidden="true"><li><a href="mailto:neilstottler@duck.com" target="_self">Email</a></li><li><a href="https://tf2maps.net/members/nesman.23849/" target="_self">TF2Maps</a></li><li><a href="https://github.com/neilstottler" target="_self">Github</a></li></ul></li></ul></nav><footer id="footer"><p class="copyright align-center">© Neil Stottler 2022</p><p class="copyright align-center">Designed using Publii</p></footer></div></div></div><script src="https://nesman.dev/assets/js/jquery.min.js?v=7c14a783dfeb3d238ccd3edd840d82ee"></script><script src="https://nesman.dev/assets/js/browser.min.js?v=c07298dd19048a8a69ad97e754dfe8d0"></script><script src="https://nesman.dev/assets/js/breakpoints.min.js?v=81a479eb099e3b187613943b085923b8"></script><script src="https://nesman.dev/assets/js/util.min.js?v=cbdaf7c20ac2883c77ae23acfbabd47e"></script><script src="https://nesman.dev/assets/js/main.min.js?v=08add7f6d435054ad38ec38d7cf8be40"></script><script>var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};</script></body></html>